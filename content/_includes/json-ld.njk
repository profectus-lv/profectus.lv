{% if siteelements.features.json_ld %}
{# Page description #}
{% set description -%}{% getShortDescription %}{%- endset %}

{# Page type detection #}
{% set isPost = tags and ('posts' in tags) %}
{% set isAuthorPage = tags and ('authorcard' in tags) %}
{% set pageUrl = page.url | absoluteUrl %}
{% set imageSrc = image or siteconfig.openGraphDefaultImage %}
{% set isProfilePage = (not isPost and not isAuthorPage and profilePage) %}

{# Detect events: any tag included in sitetags.events #}
{% set isEvent = false %}
{% if tags %}
    {% for evtag in sitetags.events %}
        {% if evtag in tags %}{% set isEvent = true %}{% endif %}
    {% endfor %}
{% endif %}

{# Unified author derivation (for both posts and author pages) #}
{% set activeAuthorId = author or siteconfig.author %}
{% set activeAuthorData = siteauthors[activeAuthorId] %}
{% set activeAuthorDisplayName = activeAuthorData.fullName or activeAuthorId %}
{% set authorImage = activeAuthorData.photo or siteconfig.image %}
{% set authorPageUrl = ('/author/' ~ (activeAuthorId | slugify) ~ '/') | absoluteUrl %}

{# Generate keywords from tags #}
{% if isPost %}
    {% set keywords = [] %}
    {% for t in tags %}
        {% if t not in sitetags.notag %}
            {% set kw = sitestrings[siteconfig.lang][t] or t %}
            {% set keywords = keywords.concat([kw]) %}
        {% endif %}
    {% endfor %}
{% endif %}

{# Author sameAs links #}
{% set sameAs = [activeAuthorData.website] if activeAuthorData.website else [] %}
{% set social = activeAuthorData.social or {} %}
{% for key, value in social %}
    {% set cfg = socialconfig[key] %}
    {% set sameAs = sameAs.concat([cfg.prefix ~ value]) %}
{% endfor %}

{# Publisher sameAs links #}
{% set publisherSameAs = [] %}
{% for key, value in siteelements.social %}
    {% set cfg = socialconfig[key] %}
    {% set publisherSameAs = publisherSameAs.concat([cfg.prefix ~ value]) %}
{% endfor %}

{# Publisher context #}
{% set publisherData = siteauthors[siteconfig.author] %}
{% set publisherName = publisherData.fullName or siteconfig.author %}
{% set publisherImage = publisherData.photo or siteconfig.image %}

<script type="application/ld+json">
{
    "@context": "https://schema.org",
    "@graph": [
        {
            "@type": "WebSite",
            "@id": "{{ siteconfig.url }}#website",
            "name": "{{ siteconfig.title }}",
            "url": "{{ siteconfig.url }}",
            "inLanguage": "{{ siteconfig.lang }}",
            "description": "{{ siteconfig.description }}",
            "logo": {
                "@type": "ImageObject",
                "url": "{{ siteconfig.url }}{% imageTransform siteconfig.image, 1200, 'webp' %}"
            },
            "publisher": {
                "@type": "{{ siteconfig.authorType }}",
                "name": "{{ publisherName }}",
                "url": "{{ siteconfig.url }}",
                {% if publisherData.bio %}"description": "{{ publisherData.bio }}",{% endif %}
                {% if publisherData.email %}"email": "{{ publisherData.email }}",{% endif %}
                {% if publisherSameAs | length %}"sameAs": {{ publisherSameAs | dump | safe }},{% endif %}
                "{{ 'image' if siteconfig.authorType == 'Person' else 'logo' }}": {
                    "@type": "ImageObject",
                    "url": "{{ siteconfig.url }}{% imageTransform publisherImage, 1200, 'webp' %}"
                }
            }
        }
        {% if isEvent %}
        ,{
            "@type": "Event",
            "@id": "{{ pageUrl }}#event",
            "name": "{{ title }}",
            "url": "{{ pageUrl }}",
            "isPartOf": { "@id": "{{ siteconfig.url }}#website" },
            "inLanguage": "{{ siteconfig.lang }}",
            "description": "{{ description }}",
            "image": [
                "{{ siteconfig.url }}{% imageTransform imageSrc, 1200, 'webp' %}"
            ],
            "startDate": "{{ page.date | isoDateTime }}",
            {% if place %}"location": {
                "@type": "Place",
                "name": "{{ place }}"{% if address %},
                "address": "{{ address }}"{% endif %}
            },{% endif %}
            "organizer": {
                "@type": "{{ siteconfig.authorType }}",
                "name": "{{ publisherName }}",
                "url": "{{ siteconfig.url }}",
                {% if publisherData.bio %}"description": "{{ publisherData.bio }}",{% endif %}
                {% if publisherData.email %}"email": "{{ publisherData.email }}",{% endif %}
                {% if publisherSameAs | length %}"sameAs": {{ publisherSameAs | dump | safe }},{% endif %}
                "{{ 'image' if siteconfig.authorType == 'Person' else 'logo' }}": {
                    "@type": "ImageObject",
                    "url": "{{ siteconfig.url }}{% imageTransform publisherImage, 1200, 'webp' %}"
                }
            }
        }
        {% elseif isPost %}
        ,{
            "@type": "BlogPosting",
            "@id": "{{ pageUrl }}#blogposting",
            "headline": "{% if title %}{{ title }} - {% endif %}{{ siteconfig.title }}",
            "url": "{{ pageUrl }}",
            "isPartOf": { "@id": "{{ siteconfig.url }}#website" },
            "mainEntityOfPage": "{{ pageUrl }}",
            "inLanguage": "{{ siteconfig.lang }}",
            "description": "{{ description }}",
            "image": [
                "{{ siteconfig.url }}{% imageTransform imageSrc, 1200, 'webp' %}"
            ],
            "datePublished": "{{ page.date | isoDateTime }}",
            {% if updated %}"dateModified": "{{ updated | isoDateTime }}",{% endif %}
            "keywords": {{ keywords | dump | safe }},
            "author": {
                "@type": "Person",
                "name": "{{ activeAuthorDisplayName }}",
                "url": "{{ authorPageUrl }}",
                {% if activeAuthorData.bio %}"description": "{{ activeAuthorData.bio }}",{% endif %}
                {% if activeAuthorData.email %}"email": "{{ activeAuthorData.email }}",{% endif %}
                {% if sameAs | length %}"sameAs": {{ sameAs | dump | safe }},{% endif %}
                "image": {
                    "@type": "ImageObject",
                    "url": "{{ siteconfig.url }}{% imageTransform authorImage, 1200, 'webp' %}"
                }
            },
            "publisher": {
                "@type": "{{ siteconfig.authorType }}",
                "name": "{{ publisherName }}",
                "url": "{{ siteconfig.url }}",
                {% if publisherData.bio %}"description": "{{ publisherData.bio }}",{% endif %}
                {% if publisherData.email %}"email": "{{ publisherData.email }}",{% endif %}
                {% if publisherSameAs | length %}"sameAs": {{ publisherSameAs | dump | safe }},{% endif %}
                "{{ 'image' if siteconfig.authorType == 'Person' else 'logo' }}": {
                    "@type": "ImageObject",
                    "url": "{{ siteconfig.url }}{% imageTransform publisherImage, 1200, 'webp' %}"
                }
            }
        }
        {% elseif isAuthorPage %}
        ,{
            "@type": "ProfilePage",
            "@id": "{{ pageUrl }}#profilepage",
            "name": "{% if title %}{{ title }} - {% endif %}{{ siteconfig.title }}",
            "url": "{{ pageUrl }}",
            "isPartOf": { "@id": "{{ siteconfig.url }}#website" },
            "mainEntity": { "@id": "{{ pageUrl }}#author" },
            "inLanguage": "{{ siteconfig.lang }}",
            "description": "{{ description }}"
        },
        {
            "@type": "Person",
            "@id": "{{ pageUrl }}#author",
            "name": "{{ activeAuthorDisplayName }}",
            "url": "{{ pageUrl }}",
            {% if activeAuthorData.bio %}"description": "{{ activeAuthorData.bio }}",{% endif %}
            {% if activeAuthorData.email %}"email": "{{ activeAuthorData.email }}",{% endif %}
            {% if sameAs | length %}"sameAs": {{ sameAs | dump | safe }},{% endif %}
            "image": {
                "@type": "ImageObject",
                "url": "{{ siteconfig.url }}{% imageTransform authorImage, 1200, 'webp' %}"
            }
        }
        {% elseif isProfilePage %}
        ,{
            "@type": "ProfilePage",
            "@id": "{{ pageUrl }}#profilepage",
            "name": "{% if title %}{{ title }} - {% endif %}{{ siteconfig.title }}",
            "url": "{{ pageUrl }}",
            "isPartOf": { "@id": "{{ siteconfig.url }}#website" },
            "mainEntity": { "@id": "{{ pageUrl }}#profile" },
            "inLanguage": "{{ siteconfig.lang }}",
            "description": "{{ description }}"
        },
        {
            "@type": "{{ siteconfig.authorType }}",
            "@id": "{{ pageUrl }}#profile",
            "name": "{{ publisherName }}",
            "url": "{{ siteconfig.url }}",
            {% if publisherData.bio %}"description": "{{ publisherData.bio }}",{% endif %}
            {% if publisherData.email %}"email": "{{ publisherData.email }}",{% endif %}
            {% if publisherSameAs | length %}"sameAs": {{ publisherSameAs | dump | safe }},{% endif %}
            "{{ 'image' if siteconfig.authorType == 'Person' else 'logo' }}": {
                "@type": "ImageObject",
                "url": "{{ siteconfig.url }}{% imageTransform publisherImage, 1200, 'webp' %}"
            }
        }
        {% else %}
        ,{
            "@type": "WebPage",
            "@id": "{{ pageUrl }}#webpage",
            "name": "{% if title %}{{ title }} - {% endif %}{{ siteconfig.title }}",
            "url": "{{ pageUrl }}",
            "isPartOf": { "@id": "{{ siteconfig.url }}#website" },
            "inLanguage": "{{ siteconfig.lang }}",
            "description": "{{ description }}"
        }
        {% endif %}
    ]
}
</script>
{% endif %}